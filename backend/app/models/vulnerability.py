"""Vulnerability model."""

from __future__ import annotations

from datetime import datetime
from typing import TYPE_CHECKING

from sqlalchemy import Boolean, DateTime, Float, ForeignKey, Index, Integer, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship, synonym

from app.database import Base
from app.utils.timezone import get_now

if TYPE_CHECKING:
    from app.models.scan import Scan


class Vulnerability(Base):
    """Individual vulnerability found in a scan."""

    __tablename__ = "vulnerabilities"
    __table_args__ = (
        # Composite indexes for common query patterns
        Index("ix_vuln_severity_fixable", "severity", "is_fixable"),
        Index("ix_vuln_status_severity", "status", "severity"),
        Index("ix_vuln_scan_severity", "scan_id", "severity"),
        Index("ix_vuln_package_cve", "package_name", "cve_id"),
        Index("ix_vuln_kev", "is_kev"),  # Index for KEV filtering
    )

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    scan_id: Mapped[int] = mapped_column(Integer, ForeignKey("scans.id"), nullable=False)
    scan_result_id = synonym("scan_id")

    # CVE Information
    cve_id: Mapped[str] = mapped_column(String, nullable=False, index=True)
    package_name: Mapped[str] = mapped_column(String, nullable=False, index=True)
    severity: Mapped[str] = mapped_column(String, nullable=False, index=True)  # CRITICAL, HIGH, etc
    cvss_score: Mapped[float | None] = mapped_column(Float, nullable=True)

    # Description and details
    title: Mapped[str | None] = mapped_column(String, nullable=True)
    description: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Version information
    installed_version: Mapped[str] = mapped_column(String, nullable=False)
    fixed_version: Mapped[str | None] = mapped_column(String, nullable=True)
    is_fixable: Mapped[bool] = mapped_column(Boolean, default=False, index=True)

    # References and links
    primary_url: Mapped[str | None] = mapped_column(String, nullable=True)
    references: Mapped[str | None] = mapped_column(Text, nullable=True)  # JSON array of URLs

    # Scanner information
    scanner: Mapped[str] = mapped_column(
        String, default="trivy", index=True
    )  # trivy (Grype removed in v2.7)
    confidence: Mapped[str | None] = mapped_column(
        String, nullable=True, index=True
    )  # HIGH, MEDIUM, LOW
    found_by_scanners: Mapped[str | None] = mapped_column(
        Text, nullable=True
    )  # JSON array: ["trivy"]

    # Management
    status: Mapped[str] = mapped_column(
        String, default="to_fix", index=True
    )  # to_fix, accepted, false_positive, ignored
    notes: Mapped[str | None] = mapped_column(Text, nullable=True)

    # KEV (Known Exploited Vulnerabilities) Information
    is_kev: Mapped[bool] = mapped_column(Boolean, default=False, index=True)
    kev_added_date: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)
    kev_due_date: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=get_now)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=get_now, onupdate=get_now)

    # Relationships
    scan: Mapped[Scan] = relationship("Scan", back_populates="vulnerabilities")
