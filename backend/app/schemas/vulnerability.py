"""Vulnerability schemas."""

from datetime import datetime

from pydantic import BaseModel, ConfigDict


class VulnerabilityBase(BaseModel):
    """Base vulnerability schema."""

    cve_id: str
    package_name: str
    severity: str
    installed_version: str
    fixed_version: str | None


class VulnerabilityUpdate(BaseModel):
    """Schema for updating vulnerability status."""

    status: str | None = None  # to_fix, accepted, false_positive, ignored
    notes: str | None = None


class Vulnerability(VulnerabilityBase):
    """Full vulnerability schema."""

    model_config = ConfigDict(from_attributes=True)

    id: int
    scan_id: int
    cvss_score: float | None
    title: str | None
    description: str | None
    is_fixable: bool
    primary_url: str | None
    references: str | None
    scanner: str  # trivy (Grype removed in v2.7)
    confidence: str | None  # HIGH, MEDIUM, LOW
    found_by_scanners: str | None  # JSON array
    status: str
    notes: str | None
    is_kev: bool
    kev_added_date: datetime | None
    kev_due_date: datetime | None
    created_at: datetime
    updated_at: datetime


class VulnerabilitySummary(BaseModel):
    """Vulnerability with container context."""

    model_config = ConfigDict(from_attributes=True)

    id: int
    cve_id: str
    container_name: str
    container_id: int
    package_name: str
    severity: str
    cvss_score: float | None
    installed_version: str
    fixed_version: str | None
    is_fixable: bool
    scanner: str
    confidence: str | None
    status: str
    title: str | None
    is_kev: bool
    kev_added_date: datetime | None
    kev_due_date: datetime | None


class VulnerabilityStats(BaseModel):
    """Vulnerability statistics."""

    total: int
    fixable: int
    kev_count: int
    by_severity: dict[str, int]
    by_status: dict[str, int]
    top_packages: list[dict[str, int | str]]  # package name, count


class RemediationGroup(BaseModel):
    """Group of vulnerabilities that can be fixed by updating a package."""

    package_name: str
    installed_version: str
    fixed_version: str
    cve_count: int
    critical_count: int
    high_count: int
    medium_count: int
    low_count: int


class PaginatedVulnerabilities(BaseModel):
    """Paginated vulnerability response."""

    vulnerabilities: list[VulnerabilitySummary]
    total: int
    limit: int
    offset: int
    has_more: bool
